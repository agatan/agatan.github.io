---
title: "ISUCON 7 本戦出場してきました 「都営三田線東急目黒線直通急行日吉行」"
date: 2017-11-26T05:18:59.000Z
tags: ["ISUCON"]
---

<p>ISUCON 7 お疲れ様でした！</p>

<p>僕らのチーム，「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%D4%B1%C4%BB%B0%C5%C4%C0%FE">都営三田線</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%C5%EC%B5%DE%CC%DC%B9%F5%C0%FE">東急目黒線</a>直通急行日吉行」は学生枠 2 位，全体で 10 位という結果でした．</p>

<p>予選の結果が異常によかったので完全に調子に乗っていたんですが，本戦はやっぱり難しかったですね... 本戦でも社会人上位勢と戦えるくらいのスコアを出すのと学生枠優勝が目標だったのでやっぱりくやしい．</p>

<h3>やったこと</h3>

<p>結局テンパりすぎてスコア記録を残せていないので，なんとなく記憶を頼りに...</p>

<p>Go 実装でいきました．</p>

<ul>
<li>room 名から ws をつなぎに行くホストが一台に固定されるように

<ul>
<li>同じルームの action は全部同じホストにいくように</li>
<li>これでオンメモリに出来るようにした（結局ほとんどオンメモリにデータは持たなかった）</li>
</ul>
</li>
<li>ルーム名から適当な<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%CF%A5%C3%A5%B7%A5%E5%C3%CD">ハッシュ値</a>を計算してふるようにしていたけれど，ルームによってアクセス頻度とかがちがうっぽい？ことに気がつく

<ul>
<li>3 台に振ってるはずなのに，CPU 使用率を見ると 2 台しか使われていないとか</li>
<li>負荷分散が<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B1%BF%A5%B2%A1%BC">運ゲー</a>になっていて改善の結果が見にくかったので，とりあえず 1 台しか使わないように</li>
</ul>
</li>
<li>ホストごとの接続数を redis に入れて，空いていそうなところに振り分けるように

<ul>
<li>前段のサーバに nginx + app + redis を入れて，そこの redis に room -> host の対応情報を入れた</li>
<li>CPU 使用率で振り分けたほうが良かったかもしれない</li>
</ul>
</li>
<li>schedule の計算過程を最適化出来る気がしなかったので，結果をキャッシュしようと試みる

<ul>
<li>どうやっても事後検証をパスできなかったので捨てることに...</li>
</ul>
</li>
<li>部屋ごとにロックをとってすべての操作を直列にした

<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A5%E9%A5%F3%A5%B6%A5%AF%A5%B7%A5%E7%A5%F3">トランザクション</a>とかが複雑すぎていじれる気がしなかったので，一旦直列にして考えることを減らそうとした</li>
<li>rollback 考えなくて良くなったのでこれ自体は良かった気がする</li>
</ul>
</li>
<li>@izumin5210 が adding/buying を redis にいれたり，過去の adding をまとめてくれた

<ul>
<li>ここは完全におまかせしてしまった</li>
<li>最終的にまともに効いたのはこれだけだったのでは</li>
</ul>
</li>
<li>終盤はベンチマーカに弾かれる原因をひたすら探していた

<ul>
<li>安全側に倒そうということで，色んな所でひたすらロックを取るようにしてなんとかパスした</li>
</ul>
</li>
</ul>

<p>という感じで，最高スコアが 17000 くらい，最終スコアが 16700 で終了しました．</p>

<h3>反省</h3>

<ul>
<li>チーム名が長すぎた

<ul>
<li>名札のチーム名部分のフォントが他のチームより小さかった気がする（ご迷惑おかけしていたらすみません...）</li>
<li>手書きで書くのがつらすぎる</li>
<li>来年は気をつけます</li>
</ul>
</li>
<li>テストがせっかく用意されていたのにまったく使わなかった

<ul>
<li>テスト使っていたらもうちょっと計算過程の最適化にも手を出せたかもしれない</li>
</ul>
</li>
<li>なにも操作がなくても 500ms ごとに status を計算していたところの最適化を入れきることができなかった

<ul>
<li>この計算は room ごとに一回やれば良いはずなのにコネクション一個につき一回計算していた</li>
<li>room ごとにひたすら status を計算し続ける goroutine を起動してそこから返す実装を書いていたが，終盤の fail 祭りにびびっていれられなかった...</li>
<li>意味があったかどうかはよくわからない．</li>
</ul>
</li>
<li>CPU profile をみて，bigint の計算がやばいことはわかっていたのに，手が出せなかった

<ul>
<li>この複雑さは結果をキャッシュしろってことだな！って勝手に思い込んでいたけど，結果のキャッシュも複雑で無理だった</li>
<li>他のチームの方の話を聞く限り，そんなに無茶な最適化じゃなくても地道に最適化していたらそれなりにスコアに効いたのかもと思った（これはやってみないとわからないけど）</li>
</ul>
</li>
</ul>

<p>予選のときも練習のときも，「遅いのはわかっているけど複雑そうでやりたくない」部分を触らないとだめっていう教訓は得ていたはずなんだけど，結局そこでやられてしまったのが一番くやしいですね...</p>

<p>来年は学生枠ではなくなるのですが，社会人枠でも本戦にでて勝ちたいです！</p>

<p>去年に引き続き本戦に出られたのはほんとうに良かったし，またまた勉強になる良い経験でした！運営の皆様お疲れ様でした ＆ ありがとうございました！</p>

---

COMMENT:
AUTHOR: davidcruise
IP: 117.98.190.10
DATE: 11/27/2017 21:25:12
<a href='https://www.kikforpcapp.com/kik-for-pc-windows-xp788-110-free-download/'>pc kik</a> article on an innovative messaging amenity that is continually on, permanently linked with fast and unswerving than any added applications that are existing due to some of the following reasons.

---

---
